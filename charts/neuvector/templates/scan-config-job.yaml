{{- if and .Values.scan.enabled .Values.neuvector.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "neuvector.fullname" . }}-scan-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuvector.labels" . | nindent 4 }}
    app.kubernetes.io/component: scan-config
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "neuvector.labels" . | nindent 8 }}
        app.kubernetes.io/component: scan-config
    spec:
      serviceAccountName: {{ .Values.scan.api.serviceAccount.name }}
      restartPolicy: OnFailure
      containers:
      - name: scan-config
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          NAMESPACE="{{ .Release.Namespace }}"
          SCAN_FREQ="{{ .Values.scan.frequency }}"
          
          if [ "$SCAN_FREQ" = "daily" ]; then
            SCHEDULE="{{ .Values.scan.schedule.daily }}"
          else
            SCHEDULE="{{ .Values.scan.schedule.weekly }}"
          fi
          
          echo "=========================================="
          echo "NeuVector Scan Configuration"
          echo "=========================================="
          echo "Frequency: $SCAN_FREQ"
          echo "Schedule: $SCHEDULE"
          echo "Namespace: $NAMESPACE"
          echo "=========================================="
          
          # Wait for NeuVector controller to be ready
          echo "Waiting for NeuVector controller to be ready..."
          MAX_RETRIES={{ .Values.scan.api.retries }}
          RETRY_DELAY={{ .Values.scan.api.retryDelay }}
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if kubectl get pods -n $NAMESPACE -l app=neuvector-controller-pod --field-selector=status.phase=Running 2>/dev/null | grep -q neuvector-controller; then
              echo "Controller pod is running"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Retry $RETRY_COUNT/$MAX_RETRIES: Waiting for controller pod..."
            sleep $RETRY_DELAY
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "WARNING: Controller pod not ready after $MAX_RETRIES retries"
            echo "Continuing with ConfigMap creation..."
          fi
          
          # Create ConfigMap with scan configuration
          echo "Creating scan configuration ConfigMap..."
          kubectl create configmap {{ include "neuvector.fullname" . }}-scan-config \
            --from-literal=frequency="$SCAN_FREQ" \
            --from-literal=schedule="$SCHEDULE" \
            --from-literal=scanLayers="{{ .Values.registryScan.scanLayers }}" \
            --from-literal=scanSecrets="{{ .Values.registryScan.scanSecrets }}" \
            -n $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "=========================================="
          echo "Scan configuration ConfigMap created successfully"
          echo "=========================================="
          echo ""
          echo "NOTE: To apply scan schedules to registries:"
          echo "1. Access NeuVector UI via Rancher"
          echo "2. Navigate to Assets > Registries"
          echo "3. Configure scan schedule for each registry:"
          echo "   - Daily: {{ .Values.scan.schedule.daily }}"
          echo "   - Weekly: {{ .Values.scan.schedule.weekly }}"
          echo ""
          echo "Or use NeuVector REST API to configure programmatically."
          echo "ConfigMap '{{ include "neuvector.fullname" . }}-scan-config' contains the schedule values."
          echo "=========================================="
        env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
      {{- with .Values.scan.api.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.scan.api.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
---
{{- if .Values.scan.api.serviceAccount.create }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.scan.api.serviceAccount.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuvector.labels" . | nindent 4 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Values.scan.api.serviceAccount.name }}-role
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuvector.labels" . | nindent 4 }}
rules:
- apiGroups: [""]
  resources: ["pods", "configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Values.scan.api.serviceAccount.name }}-rolebinding
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuvector.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Values.scan.api.serviceAccount.name }}-role
subjects:
- kind: ServiceAccount
  name: {{ .Values.scan.api.serviceAccount.name }}
  namespace: {{ .Release.Namespace }}
{{- end }}
{{- end }}

